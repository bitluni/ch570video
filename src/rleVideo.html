<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Video → RLE C array converter</title>
<style>
  body { font-family:sans-serif; background:#f7f8fb; color:#111; padding:18px; }
  h1 { margin:0 0 8px }
  .row { display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin:8px 0 }
  label { font-size:13px }
  input[type="range"]{ width:200px }
  input, button, textarea { font-size:13px; padding:6px; border:1px solid #ccc; border-radius:6px }
  button{ cursor:pointer }
  .videos{ display:flex; gap:12px; margin-top:12px }
  video, canvas { border:1px solid #ddd; border-radius:6px; background:black; max-width:100% }
  .previewBox{ display:flex; flex-direction:column; align-items:center; gap:6px }
  textarea#out{ width:100%; height:320px; font-family:monospace; white-space:pre; resize:vertical }
  .small{ font-size:12px; color:#444 }
</style>
</head>
<body>
<h1>Video → RLE C array converter</h1>

<div class="row">
  <label>File</label>
  <input id="videoFile" type="file" accept="video/*">
  <label>Array name</label>
  <input id="arrayName" type="text" value="my_animation">
  <label>FPS</label>
  <input id="fps" type="number" value="10" min="1" max="60" style="width:60px">
</div>

<div class="row">
  <label>X</label><input id="xres" type="number" value="300" style="width:60px">
  <label>Y</label><input id="yres" type="number" value="280" style="width:60px">
  <label>Levels</label><input id="levels" type="number" value="12" style="width:80px">
  <label>Offset</label><input id="valueOffset" type="number" value="1" style="width:60px">
  <label>Gamma</label><input id="gamma" type="number" value="1.0" step="0.1" style="width:60px">
  <label>Detail reduce</label><input id="reduceDetail" type="range" min="0" max="5" value="1"><span id="reduceDetailVal">0</span>
</div>

<div class="row">
  <label>Dark clip</label><input id="darkClip" type="range" min="0" max="255" value="0"><span id="darkClipVal">0</span>
  <label>Bright clip</label><input id="brightClip" type="range" min="0" max="255" value="159"><span id="brightClipVal">255</span>
</div>

<div class="row">
  <label>Start</label><input id="startFrame" type="range" min="0" max="0" value="0"><span id="startFrameVal">0</span>
  <label>End</label><input id="endFrame" type="range" min="0" max="0" value="0"><span id="endFrameVal">0</span>
  <button id="setRange">Set from current</button>
</div>

<div class="row">
  <button id="btnPrepare">Prepare preview</button>
  <button id="btnConvert">Convert → C</button>
</div>

<div class="videos">
  <div class="previewBox">
    <div class="small">Original</div>
    <video id="origVideo" controls></video>
  </div>
  <div class="previewBox">
    <div class="small">Processed preview</div>
    <canvas id="processedCanvas"></canvas>
  </div>
</div>

<div style="margin-top:12px">
  <textarea id="out" readonly></textarea><br>
  <button id="copyBtn">Copy</button>
  <button id="downloadBtn">Download .c</button>
</div>

<script>
const fileEl=document.getElementById('videoFile');
const origVideo=document.getElementById('origVideo');
const canvas=document.getElementById('processedCanvas');
const ctx=canvas.getContext("2d");
const startEl=document.getElementById('startFrame');
const endEl=document.getElementById('endFrame');
const startVal=document.getElementById('startFrameVal');
const endVal=document.getElementById('endFrameVal');
const fpsEl=document.getElementById('fps');
const levelsEl=document.getElementById('levels');
const offsetEl=document.getElementById('valueOffset');
const gammaEl=document.getElementById('gamma');
const reduceDetailEl=document.getElementById('reduceDetail');
const reduceDetailVal=document.getElementById('reduceDetailVal');
const darkClipEl=document.getElementById('darkClip');
const brightClipEl=document.getElementById('brightClip');
const darkClipVal=document.getElementById('darkClipVal');
const brightClipVal=document.getElementById('brightClipVal');
const outArea=document.getElementById('out');
const arrayNameEl=document.getElementById('arrayName');
const copyBtn=document.getElementById('copyBtn');
const downloadBtn=document.getElementById('downloadBtn');

let frames=[],previewTimer;

fileEl.addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f) return;
  const url=URL.createObjectURL(f);
  origVideo.src=url; origVideo.load();
  origVideo.onloadedmetadata=()=>{
    const fps=+fpsEl.value;
    const total=Math.floor(origVideo.duration*fps);
    startEl.max=total-1; endEl.max=total-1;
    endEl.value=total-1; startVal.textContent=startEl.value; endVal.textContent=endEl.value;
  };
});

startEl.oninput=()=>startVal.textContent=startEl.value;
endEl.oninput=()=>endVal.textContent=endEl.value;
reduceDetailEl.oninput=()=>reduceDetailVal.textContent=reduceDetailEl.value;
darkClipEl.oninput=()=>darkClipVal.textContent=darkClipEl.value;
brightClipEl.oninput=()=>brightClipVal.textContent=brightClipEl.value;

document.getElementById('setRange').onclick=()=>{
  const fps=+fpsEl.value;
  const idx=Math.floor(origVideo.currentTime*fps);
  startEl.value=idx; startVal.textContent=idx;
  endEl.value=Math.min(idx+30,endEl.max); endVal.textContent=endEl.value;
};

document.getElementById('btnPrepare').onclick=async()=>{
  frames=[];
  const W=+document.getElementById('xres').value, H=+document.getElementById('yres').value;
  canvas.width=W; canvas.height=H;
  const fps=+fpsEl.value;
  const s=+startEl.value, e=+endEl.value;
  const off=document.createElement('canvas'); off.width=W; off.height=H;
  const octx=off.getContext('2d',{willReadFrequently:true});
  for(let f=s;f<=e;f++){
    origVideo.currentTime=f/fps;
    await new Promise(r=>origVideo.onseeked=r);
    octx.drawImage(origVideo,0,0,W,H);
    const img=octx.getImageData(0,0,W,H);
    frames.push(mapImage(img.data,W,H));
  }
  startPreview();
  outArea.value=`Prepared ${frames.length} frames.`;
};

function blur(src,W,H,r){
  if(r<=0) return src;
  const dst=new Uint8ClampedArray(src.length);
  for(let y=0;y<H;y++){
    for(let x=0;x<W;x++){
      let R=0,G=0,B=0,A=0,c=0;
      for(let dy=-r;dy<=r;dy++){
        for(let dx=-r;dx<=r;dx++){
          const xx=x+dx,yy=y+dy;
          if(xx>=0&&xx<W&&yy>=0&&yy<H){
            const i=(yy*W+xx)*4;
            R+=src[i];G+=src[i+1];B+=src[i+2];A+=src[i+3];c++;
          }
        }
      }
      const o=(y*W+x)*4;
      dst[o]=R/c;dst[o+1]=G/c;dst[o+2]=B/c;dst[o+3]=A/c;
    }
  }
  return dst;
}

function mapImage(pix,W,H){
  const lev=+levelsEl.value, off=+offsetEl.value, g=+gammaEl.value;
  const dark=+darkClipEl.value, bright=+brightClipEl.value;
  let p=pix; if(+reduceDetailEl.value>0) p=blur(p,W,H,+reduceDetailEl.value);
  const out=new Uint8Array(W*H);
  for(let i=0;i<W*H;i++){
    const idx=i*4;
    if(p[idx+3]<128){ out[i]=0; continue; }
    let lum=0.2126*p[idx]+0.7152*p[idx+1]+0.0722*p[idx+2];
    if(lum>bright){out[i]=lev -1; continue;} ;
    if(lum<dark){out[i]=0; continue;};
    lum=Math.pow(lum/255,1/Math.max(0.001,g));
    let v=Math.floor(lum*(lev-1)+0.5);
    let m=v+off;
    if(m>255)m=255;if(m<1)m=1;
    out[i]=m;
  }
  return out;
}

function startPreview(){
  if(previewTimer) cancelAnimationFrame(previewTimer);
  const W=canvas.width,H=canvas.height;
  const image=ctx.createImageData(W,H);
  let idx=0,last=performance.now(); const interval=1000/(+fpsEl.value);
  function step(now){
    if(!frames.length)return;
    if(now-last>=interval){
      last=now;
      const fr=frames[idx];
      for(let i=0;i<fr.length;i++){
        const v=fr[i];
        if(v===0){image.data[i*4]=0;image.data[i*4+1]=0;image.data[i*4+2]=0;image.data[i*4+3]=60;}
        else{const d=Math.min(255,Math.floor(v/(+levelsEl.value)*255));
          image.data[i*4]=d;image.data[i*4+1]=d;image.data[i*4+2]=d;image.data[i*4+3]=255;}
      }
      ctx.putImageData(image,0,0);
      idx=(idx+1)%frames.length;
    }
    previewTimer=requestAnimationFrame(step);
  }
  previewTimer=requestAnimationFrame(step);
}

// ---------- RLE ENCODING ----------
function encodeFrames(){
  if(!frames.length){ outArea.value="No frames."; return; }
  const W=canvas.width,H=canvas.height;
  const arrName=arrayNameEl.value||"anim";
  let data=[], offsets=[];
  let offset=0;
  // first frame full encode
  data.push(...rle(frames[0]));
  offsets.push(0);
  offset=data.length;
  // following frames only encode changes
  for(let f=1;f<frames.length;f++){
    offsets.push(offset);
    data.push(...rleDiff(frames[f-1],frames[f]));
    offset=data.length;
  }
  // build C code
  let out="";
  out+=`// ${frames.length} frames, size ${W}x${H}\n`;
  out+=`const uint8_t ${arrName}_data[] PROGMEM = {\n  `;
  for(let i=0;i<data.length;i++){
    out+=data[i]+",";
    if((i+1)%16===0) out+="\n  ";
  }
  out+="\n};\n\n";
  out+=`const uint16_t ${arrName}_offsets[] PROGMEM = {\n  `;
  for(let i=0;i<offsets.length;i++){
    out+=offsets[i]+",";
    if((i+1)%16===0) out+="\n  ";
  }
  out+="\n};\n";
  outArea.value=out;
}

function rle(frame){
  const out=[]; let run=1,color=frame[0];
  for(let i=1;i<frame.length;i++){
    if(frame[i]===color && run<255){ run++; }
    else{ out.push(run,color); run=1;color=frame[i]; }
  }
  out.push(run,color);
  return out;
}
function rleDiff(prev,cur){
  const out=[]; let run=0,color=0;
  function flush(){ if(run>0){ out.push(run,color); run=0; } }
  for(let i=0;i<cur.length;i++){
    let v=(Math.abs(cur[i]-prev[i]) < 3)?0:cur[i];
    if(v===color && run<255){ run++; }
    else{ flush(); color=v; run=1; }
  }
  flush();
  return out;
}

document.getElementById('btnConvert').onclick=encodeFrames;

copyBtn.onclick=()=>{ navigator.clipboard.writeText(outArea.value); };
downloadBtn.onclick=()=>{
  const blob=new Blob([outArea.value],{type:"text/plain"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=(arrayNameEl.value||"anim")+".c";
  a.click();
};
</script>
</body>
</html>
